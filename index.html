<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>採購專案管理系統 - 複選與快照優化版</title>
    <!-- 引入核心樣式與套件 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9; 
            margin: 0; padding: 0; color: #1e293b; 
        }
        
        /* 列印格式優化 */
        @media print {
            .no-print, button, select, input, .filter-bar, nav, header { display: none !important; }
            .min-h-screen { background-color: white !important; padding: 0 !important; }
            .max-w-\[1400px\] { max-width: 100% !important; margin: 0 !important; }
            .timeline-card { box-shadow: none !important; border: none !important; padding: 0 !important; }
            @page { size: landscape; margin: 1cm; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 進度條連續感樣式 */
        .progress-segment {
            height: 100%;
            position: absolute;
            transition: all 0.4s ease;
            box-sizing: border-box;
            border-top: 2px solid white;
            border-bottom: 2px solid white;
        }
        .segment-rounded-l { border-top-left-radius: 14px; border-bottom-left-radius: 14px; border-left: 2px solid white; }
        .segment-rounded-r { border-top-right-radius: 14px; border-bottom-right-radius: 14px; border-right: 2px solid white; }

        /* 清單分段進度條 */
        .step-bar {
            height: 6px;
            flex: 1;
            border-radius: 10px;
            background-color: #f1f5f9;
        }

        /* 展開按鈕視覺強化 */
        .expand-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 刪除鍵(X)視覺強化 */
        .delete-btn-x {
            background-color: #ef4444;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4);
            transition: all 0.2s ease;
        }
        .delete-btn-x:hover {
            transform: scale(1.15);
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // --- 核心配置 ---
        const THEME = {
            purple: '#9B0070', teal: '#00919E', indigo: '#4F46E5', success: '#10B981',
            warning: '#F59E0B', danger: '#EF4444', planned: '#E2E8F0', overdue: '#FCA5A5'
        };

        const STAGE_CONFIG = [
            { id: 1, name: '請購(簽呈)', category: 'demand', color: '#99D5D9' },
            { id: 2, name: '詢比議價', category: 'procurement', color: '#9B0070' },
            { id: 3, name: '採購單簽核', category: 'procurement', color: '#9B0070' },
            { id: 4, name: '合約作業', category: 'contract', color: '#4F46E5' },
            { id: 5, name: '已完成/核准', category: 'contract', color: '#10B981' }
        ];

        const STATUS_CONFIG = [
            { id: 'normal', name: '正常執行', color: '#10B981' },
            { id: 'paused', name: '暫停中', color: '#F59E0B' },
            { id: 'cancelled', name: '已取消', color: '#EF4444' }
        ];

        const MONTHS = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        const AVAILABLE_YEARS = ['2025', '2026', '2027', '2028', '2029', '2030'];

        const Icon = ({ name, size = 16, color = "currentColor", className = "" }) => {
            if (!window.lucide) return <div style={{width:size, height:size}} />;
            const kebabName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
            const iconData = window.lucide.icons[kebabName];
            if (!iconData) return <div style={{width:size, height:size}} />;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{
                    __html: iconData[1].map(tag => `<${tag[0]} ${Object.entries(tag[1]).map(([k, v]) => `${k}="${v}"`).join(' ')}></${tag[0]}>`).join('')
                }} />
            );
        };

        const App = () => {
            // --- 預填模擬數據 ---
            const MOCK_PROJECTS = [
                {
                    id: 1, title: '行政大樓外牆拉皮工程', year: '2026', budget: 3500000, dept: ['營繕組', '總務部'], handler: '林小華', stage: 2, status: 'normal', hasSubTasks: true,
                    tasks: [
                        { id: 11, name: '鷹架架設', actual: { demand: { start: '2026-01-05', end: '2026-01-20' }, procurement: { start: '2026-01-21', end: '2026-02-10' }, contract: { start: '2026-02-11', end: '2026-02-28' } } },
                        { id: 12, name: '磁磚剔除', actual: { demand: { start: '2026-02-15', end: '2026-03-05' }, procurement: { start: '2026-03-06', end: '2026-03-25' }, contract: { start: '', end: '' } } }
                    ],
                    planned: { demand: { start: '2026-01-01', end: '2026-01-25' }, procurement: { start: '2026-01-26', end: '2026-03-15' }, contract: { start: '2026-03-16', end: '2026-04-30' } },
                    actual: { demand: { start: '2026-01-02', end: '2026-01-28' }, procurement: { start: '2026-01-29', end: '' }, contract: { start: '', end: '' } }
                }
            ];

            const [projects, setProjects] = useState(() => {
                const s = localStorage.getItem('proc_final_v52_projects');
                return s ? JSON.parse(s) : MOCK_PROJECTS;
            });
            const [departments, setDepartments] = useState(() => {
                const s = localStorage.getItem('proc_final_v52_depts');
                return s ? JSON.parse(s) : ['資訊部', '總務部', '營繕組', '教務處', '學務處'];
            });
            const [handlers, setHandlers] = useState(() => {
                const s = localStorage.getItem('proc_final_v52_handlers');
                return s ? JSON.parse(s) : ['林小華', '張小芬', '系統管理員'];
            });

            useEffect(() => localStorage.setItem('proc_final_v52_projects', JSON.stringify(projects)), [projects]);
            useEffect(() => localStorage.setItem('proc_final_v52_depts', JSON.stringify(departments)), [departments]);
            useEffect(() => localStorage.setItem('proc_final_v52_handlers', JSON.stringify(handlers)), [handlers]);

            const [viewMode, setViewMode] = useState('list'); 
            const [timelineDisplay, setTimelineDisplay] = useState('dual');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingModalOpen, setIsSettingModalOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [expandedProjectIds, setExpandedProjectIds] = useState(new Set());
            const [deleteConfirmId, setDeleteConfirmId] = useState(null); 
            const [searchTerm, setSearchTerm] = useState('');
            const [filterYear, setFilterYear] = useState('2026');
            const [filterHandler, setFilterHandler] = useState('All');
            const [newDeptInput, setNewDeptInput] = useState('');
            const [newHandlerInput, setNewHandlerInput] = useState('');

            const [newProject, setNewProject] = useState({
                title: '', year: '2026', budget: '', dept: [], handler: '', stage: 1, status: 'normal', hasSubTasks: false,
                p_demandS: '', p_demandE: '', p_procS: '', p_procE: '', p_contS: '', p_contE: ''
            });

            // --- 核心邏輯修正 ---

            const updateProjectMain = (updated) => {
                if (!updated) return;
                setProjects(prev => prev.map(p => p.id === updated.id ? updated : p));
                setEditingProject(null);
            };

            const handleAddProject = (e) => {
                e.preventDefault();
                const project = {
                    id: Date.now(), ...newProject,
                    dept: newProject.dept.length > 0 ? newProject.dept : [departments[0]],
                    handler: newProject.handler || handlers[0],
                    budget: Number(newProject.budget) || 0,
                    tasks: [],
                    planned: {
                        demand: { start: newProject.p_demandS, end: newProject.p_demandE },
                        procurement: { start: newProject.p_procS, end: newProject.p_procE },
                        contract: { start: newProject.p_contS, end: newProject.p_contE }
                    },
                    actual: { demand: { start: '', end: '' }, procurement: { start: '', end: '' }, contract: { start: '', end: '' } }
                };
                setProjects(prev => [...prev, project]);
                setIsModalOpen(false);
                setNewProject({ title: '', year: filterYear, budget: '', dept: [], handler: handlers[0], stage: 1, status: 'normal', hasSubTasks: false, p_demandS: '', p_demandE: '', p_procS: '', p_procE: '', p_contS: '', p_contE: '' });
            };

            const toggleExpansion = (id) => {
                setExpandedProjectIds(prev => {
                    const next = new Set(prev);
                    if (next.has(id)) next.delete(id); else next.add(id);
                    return next;
                });
            };

            const handleDeptToggle = (target, deptName) => {
                if (target === 'new') {
                    const next = newProject.dept.includes(deptName) ? newProject.dept.filter(d => d !== deptName) : [...newProject.dept, deptName];
                    setNewProject({...newProject, dept: next});
                } else if (editingProject) {
                    const next = editingProject.dept.includes(deptName) ? editingProject.dept.filter(d => d !== deptName) : [...editingProject.dept, deptName];
                    setEditingProject({...editingProject, dept: next});
                }
            };

            const addSubTask = (name) => {
                if (!name || !editingProject) return;
                const newTask = {
                    id: Date.now(), name,
                    actual: { demand: { start: '', end: '' }, procurement: { start: '', end: '' }, contract: { start: '', end: '' } }
                };
                setEditingProject({...editingProject, tasks: [...(editingProject.tasks || []), newTask]});
            };

            const checkOverdue = (pEnd, aEnd) => (pEnd && aEnd && new Date(aEnd) > new Date(pEnd));

            const calculateBar = (start, end) => {
                if (!start || !end) return { display: 'none' };
                const viewYear = parseInt(filterYear);
                const sDate = new Date(start);
                const eDate = new Date(end);
                const yStart = new Date(`${viewYear}-01-01`);
                if (eDate < yStart || sDate > new Date(`${viewYear}-12-31`)) return { display: 'none' };
                const sDiff = Math.max(0, (sDate - yStart) / (1000 * 60 * 60 * 24));
                const eDiff = Math.min(365, (eDate - yStart) / (1000 * 60 * 60 * 24) + 1);
                return { left: `${(sDiff / 365) * 100}%`, width: `${((eDiff - sDiff) / 365) * 100}%` };
            };

            const filteredProjects = useMemo(() => {
                return projects.filter(p => {
                    const matchYear = p.year === filterYear || p.planned?.demand?.start?.startsWith(filterYear);
                    const matchSearch = p.title.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchHandler = filterHandler === 'All' || p.handler === filterHandler;
                    return matchYear && matchSearch && matchHandler;
                }).sort((a, b) => b.id - a.id);
            }, [projects, searchTerm, filterYear, filterHandler]);

            return (
                <div className="min-h-screen p-4 lg:p-10 font-bold">
                    <div className="max-w-[1400px] mx-auto">
                        
                        {/* Header */}
                        <header className="flex justify-between items-center mb-10 no-print font-black">
                            <div className="flex items-center gap-4">
                                <div className="p-4 rounded-3xl text-white shadow-xl" style={{background: THEME.purple}}><Icon name="Activity" size={32}/></div>
                                <div>
                                    <h1 className="text-3xl font-black text-slate-900 tracking-tighter uppercase">採購專案管理</h1>
                                    <p className="text-xs text-slate-400 tracking-widest uppercase mt-1 font-bold">Efficiency &roadmap control</p>
                                </div>
                            </div>
                            <div className="flex gap-2 bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200">
                                <button onClick={()=>setViewMode('list')} className={`px-6 py-2.5 rounded-xl text-xs font-black transition-all ${viewMode==='list'?'bg-slate-900 text-white shadow-lg':'text-slate-400 hover:bg-slate-50'}`}>案件清單</button>
                                <button onClick={()=>setViewMode('timeline')} className={`px-6 py-2.5 rounded-xl text-xs font-black transition-all ${viewMode==='timeline'?'bg-slate-900 text-white shadow-lg':'text-slate-400 hover:bg-slate-50'}`}>年度期程</button>
                                <button onClick={()=>setIsModalOpen(true)} className="ml-2 px-6 py-2.5 rounded-xl text-xs text-white shadow-lg active:scale-95 transition-all font-black" style={{background: THEME.purple}}>+ 新增案件</button>
                            </div>
                        </header>

                        {/* 搜尋篩選 */}
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 mb-8 flex flex-col md:flex-row gap-4 items-center no-print">
                            <div className="relative flex-1 w-full group">
                                <Icon name="Search" className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-300" size={20}/>
                                <input className="w-full pl-12 pr-6 py-3.5 bg-slate-50 border-none rounded-2xl text-sm outline-none focus:ring-2 focus:ring-purple-100" placeholder="搜尋專案名稱..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                            </div>
                            <div className="flex gap-3 items-center font-black">
                                <select className="bg-slate-50 border-none rounded-2xl px-5 py-3.5 text-sm text-indigo-700 outline-none font-bold" value={filterYear} onChange={e=>setFilterYear(e.target.value)}>
                                    {AVAILABLE_YEARS.map(y => <option key={y} value={y}>{y} 年度</option>)}
                                </select>
                                <select className="bg-slate-50 border-none rounded-2xl px-5 py-3.5 text-sm text-indigo-700 outline-none font-bold" value={filterHandler} onChange={e=>setFilterHandler(e.target.value)}>
                                    <option value="All">全部人員</option>
                                    {handlers.map(h => <option key={h} value={h}>{h}</option>)}
                                </select>
                                <button onClick={()=>setIsSettingModalOpen(true)} className="flex items-center gap-2 px-5 py-3.5 bg-slate-800 text-white rounded-2xl hover:scale-105 transition-all shadow-md font-black">
                                    <Icon name="Settings2" size={18}/>
                                    <span className="text-xs">組織人員設定</span>
                                </button>
                            </div>
                        </div>

                        {viewMode === 'list' ? (
                            /* --- 清單模式 --- */
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 animate-fade-in">
                                {filteredProjects.map(p => (
                                    <div key={p.id} className="bg-white p-8 rounded-[3.5rem] shadow-sm border border-slate-100 relative group hover:shadow-2xl transition-all font-black flex flex-col min-h-[460px]">
                                        
                                        {/* 顯著化刪除鍵 (X) */}
                                        <button onClick={()=>setDeleteConfirmId(p.id)} className="absolute top-6 right-6 delete-btn-x no-print z-30">
                                            <Icon name="X" size={16} color="white" />
                                        </button>
                                        
                                        <div className="mb-4 flex flex-wrap gap-1.5">
                                            {(p.dept || []).map(d => (
                                                <span key={d} className="px-2.5 py-0.5 bg-indigo-50 text-indigo-500 text-[9px] font-black rounded-md uppercase tracking-wider">{d}</span>
                                            ))}
                                        </div>
                                        <h3 className="text-xl font-black text-slate-800 leading-tight mb-2 flex-1">{p.title}</h3>
                                        <p className="text-2xl font-black text-indigo-600 mb-6">${p.budget.toLocaleString()}</p>
                                        
                                        {/* 案件資訊一目了然：分項快照 */}
                                        {p.hasSubTasks && p.tasks.length > 0 && (
                                            <div className="mb-8 p-4 bg-slate-50/50 rounded-2xl space-y-2 border border-slate-50 shadow-inner overflow-hidden">
                                                <div className="text-[9px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5 mb-1">
                                                    <Icon name="ListTree" size={12} color={THEME.indigo} /> 分項概覽 ({p.tasks.length} 項)
                                                </div>
                                                <div className="space-y-1.5">
                                                    {p.tasks.slice(0, 3).map(t => (
                                                        <div key={t.id} className="flex items-center justify-between text-[11px] font-bold text-slate-500">
                                                            <span className="truncate w-32">• {t.name}</span>
                                                            <span className="text-[8px] px-1.5 py-0.5 bg-white border border-slate-100 rounded text-slate-400">
                                                                {t.actual.contract.end ? '完工' : t.actual.procurement.start ? '採購' : '請購'}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        <div className="space-y-4 mb-8">
                                            <div className="flex justify-between items-center text-[11px] font-black text-slate-400 uppercase tracking-widest">
                                                <span>主流程進度</span>
                                                <span style={{color: STAGE_CONFIG[p.stage-1]?.color}}>{STAGE_CONFIG[p.stage-1]?.name}</span>
                                            </div>
                                            <div className="flex gap-1.5">
                                                {STAGE_CONFIG.map(s => (
                                                    <div key={s.id} className="step-bar" style={{backgroundColor: p.stage >= s.id ? s.color : '#f1f5f9'}} />
                                                ))}
                                            </div>
                                        </div>

                                        <div className="flex justify-between items-center pt-6 border-t border-slate-50 font-black">
                                            <div className="text-xs text-slate-400">主責: <span className="text-slate-700">{p.handler}</span></div>
                                            <button onClick={()=>setEditingProject(p)} className="flex items-center gap-1.5 text-sm text-indigo-600 hover:text-indigo-800 font-bold">
                                                <Icon name="Edit3" size={14}/> 編輯進度
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            /* --- 年度期程模式 --- */
                            <div className="bg-white p-10 rounded-[3.5rem] shadow-sm border border-slate-100 overflow-x-auto timeline-card animate-fade-in font-black">
                                <div className="min-w-[1100px]">
                                    <div className="flex flex-col md:flex-row justify-between items-end mb-12 px-4 border-b border-slate-50 pb-10 font-black">
                                        <div>
                                           <h4 className="text-2xl font-black text-slate-800 tracking-tighter">{filterYear} 年度進度大表</h4>
                                           <div className="flex gap-2 mt-4 no-print">
                                                <button onClick={()=>setTimelineDisplay('dual')} className={`px-5 py-2 rounded-xl text-xs font-black transition-all ${timelineDisplay==='dual'?'bg-indigo-600 text-white shadow-md':'bg-slate-100 text-slate-400'}`}>計畫/實際對比</button>
                                                <button onClick={()=>setTimelineDisplay('actual')} className={`px-5 py-2 rounded-xl text-xs font-black transition-all ${timelineDisplay==='actual'?'bg-indigo-600 text-white shadow-md':'bg-slate-100 text-slate-400'}`}>僅看實際階段</button>
                                            </div>
                                        </div>
                                        <button onClick={()=>window.print()} className="no-print flex items-center gap-3 px-8 py-3.5 bg-slate-900 text-white rounded-2xl text-sm font-black shadow-xl active:scale-95 transition-all"><Icon name="Printer" size={18}/> 匯出報表</button>
                                    </div>

                                    <div className="flex mb-6 px-4 font-black">
                                        <div className="w-80 flex-shrink-0 font-black text-slate-300 text-[10px] uppercase tracking-[0.3em]">專案細節與分項展開</div>
                                        <div className="flex-1 grid grid-cols-12 text-center text-xs font-black text-slate-300 border-l border-slate-50">
                                            {MONTHS.map(m => <div key={m}>{m}</div>)}
                                        </div>
                                    </div>

                                    <div className="space-y-12">
                                        {filteredProjects.map(p => {
                                            const isExp = expandedProjectIds.has(p.id);
                                            return (
                                                <div key={p.id} className="space-y-4">
                                                    <div className={`flex items-center gap-6 group`}>
                                                        <div className="w-80 flex-shrink-0 flex items-center gap-4">
                                                            <button onClick={()=>toggleExpansion(p.id)} className={`expand-btn border-2 transition-all no-print ${isExp ? 'bg-purple-700 text-white border-purple-700' : 'bg-white text-slate-300 border-slate-100 hover:text-purple-600 hover:border-purple-100'} ${p.tasks?.length > 0 || p.hasSubTasks ? '' : 'invisible'}`}>
                                                                <Icon name={isExp ? "ChevronDown" : "ChevronRight"} size={18}/>
                                                            </button>
                                                            <div className="cursor-pointer truncate flex-1 font-bold" onClick={()=>setEditingProject(p)}>
                                                                <div className="font-black text-base text-slate-800 leading-tight mb-1">{p.title}</div>
                                                                <span className="text-[9px] text-slate-400 uppercase font-black">{p.handler} | {p.dept.join(', ')}</span>
                                                            </div>
                                                        </div>
                                                        <div className="flex-1 relative h-10 bg-slate-50/50 rounded-2xl border border-slate-100 overflow-hidden font-black">
                                                            {timelineDisplay === 'dual' && (
                                                                <div className="absolute inset-0 opacity-20">
                                                                    <div className="absolute h-full bg-slate-400" style={calculateBar(p.planned.demand.start, p.planned.demand.end)}></div>
                                                                    <div className="absolute h-full bg-slate-500" style={calculateBar(p.planned.procurement.start, p.planned.procurement.end)}></div>
                                                                    <div className="absolute h-full bg-slate-600" style={calculateBar(p.planned.contract.start, p.planned.contract.end)}></div>
                                                                </div>
                                                            )}
                                                            <div className="absolute inset-y-1.5 w-full flex items-center">
                                                                {['demand', 'procurement', 'contract'].map((cat, i) => {
                                                                    const overdue = checkOverdue(p.planned[cat].end, p.actual[cat].end) && timelineDisplay === 'dual';
                                                                    const barStyle = calculateBar(p.actual[cat].start, p.actual[cat].end);
                                                                    let radiusClass = "";
                                                                    if(i===0) radiusClass = "segment-rounded-l";
                                                                    if(i===2) radiusClass = "segment-rounded-r";
                                                                    const segmentColor = timelineDisplay === 'dual' ? (overdue ? THEME.danger : THEME.purple) : STAGE_CONFIG[i === 0 ? 0 : i === 1 ? 1 : 4].color;
                                                                    return <div key={cat} className={`progress-segment shadow-sm ${radiusClass}`} style={{...barStyle, backgroundColor: segmentColor}}></div>;
                                                                })}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {isExp && p.tasks && p.tasks.map(t => (
                                                        <div key={t.id} className="flex items-center gap-6 pl-16 animate-fade-in opacity-80">
                                                            <div className="w-[15rem] flex-shrink-0 text-xs text-slate-500 truncate font-bold border-l-2 border-purple-200 pl-4">{t.name}</div>
                                                            <div className="flex-1 relative h-6 bg-slate-50/30 rounded-lg border border-slate-50 font-black">
                                                                <div className="absolute inset-y-1 w-full flex">
                                                                    {['demand', 'procurement', 'contract'].map((cat, i) => (
                                                                        <div key={cat} className="absolute h-full rounded-md opacity-60 border-r border-white/30" style={{...calculateBar(t.actual?.[cat]?.start, t.actual?.[cat]?.end), backgroundColor: [THEME.teal, THEME.purple, THEME.indigo][i]}}></div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 組織設定視窗 */}
                        {isSettingModalOpen && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[200] no-print">
                                <div className="bg-white rounded-[3rem] w-full max-w-3xl p-10 shadow-2xl animate-fade-in font-black font-bold">
                                    <div className="flex justify-between items-center mb-10 font-black">
                                        <h2 className="text-2xl font-black flex items-center gap-3"><Icon name="Settings2" color={THEME.purple}/> 組織架構維護</h2>
                                        <button onClick={()=>setIsSettingModalOpen(false)} className="p-3 bg-slate-50 rounded-full hover:bg-slate-100 transition-all font-black"><Icon name="X" size={20}/></button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-12 font-bold text-sm font-black font-bold">
                                        <div className="space-y-6 font-black font-bold">
                                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 font-black font-bold">處室管理</h3>
                                            <div className="flex items-center gap-2 font-black font-bold">
                                                <input className="flex-1 bg-slate-50 border-none rounded-xl px-5 py-3.5 text-xs shadow-inner font-black" placeholder="輸入名稱..." value={newDeptInput} onChange={e=>setNewDeptInput(e.target.value)} />
                                                <button onClick={()=>{if(newDeptInput.trim()){setDepartments(prev => [...prev, newDeptInput.trim()]); setNewDeptInput('');}}} className="bg-slate-900 text-white px-5 py-3.5 rounded-xl text-xs font-black whitespace-nowrap font-black">新增處室</button>
                                            </div>
                                            <div className="max-h-60 overflow-y-auto space-y-2 custom-scrollbar font-black">
                                                {departments.map(d=>(<div key={d} className="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100"><span>{d}</span><button onClick={()=>setDepartments(prev => prev.filter(x=>x!==d))} className="text-rose-400 font-bold font-black">移除</button></div>))}
                                            </div>
                                        </div>
                                        <div className="space-y-6 border-l border-slate-100 pl-10 font-black">
                                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 font-black font-bold font-black">承辦夥伴維護</h3>
                                            <div className="flex items-center gap-2 font-black">
                                                <input className="flex-1 bg-slate-50 border-none rounded-xl px-5 py-3.5 text-xs shadow-inner font-black" placeholder="姓名..." value={newHandlerInput} onChange={e=>setNewHandlerInput(e.target.value)} />
                                                <button onClick={()=>{if(newHandlerInput.trim()){setHandlers(prev => [...prev, newHandlerInput.trim()]); setNewHandlerInput('');}}} className="bg-slate-900 text-white px-5 py-3.5 rounded-xl text-xs font-black font-black whitespace-nowrap">新增人員</button>
                                            </div>
                                            <div className="max-h-60 overflow-y-auto space-y-2 custom-scrollbar font-black">
                                                {handlers.map(h=>(<div key={h} className="flex justify-between items-center bg-indigo-50/30 p-4 rounded-2xl border border-indigo-50"><span>{h}</span><button onClick={()=>setHandlers(prev => prev.filter(x=>x!==h))} className="text-rose-400 font-bold font-black">移除</button></div>))}
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={()=>setIsSettingModalOpen(false)} className="w-full mt-12 py-5 bg-slate-100 text-slate-900 rounded-[2rem] font-black border border-slate-200 font-black">完成所有設定</button>
                                </div>
                            </div>
                        )}

                        {/* 新增專案彈窗 */}
                        {isModalOpen && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 z-[150] overflow-y-auto no-print font-black">
                                <form onSubmit={handleAddProject} className="bg-white rounded-[4rem] w-full max-w-4xl p-12 shadow-2xl animate-fade-in font-bold font-black">
                                    <div className="flex justify-between items-center mb-10 font-black font-bold">
                                        <h2 className="text-3xl font-black text-slate-800">啟動新計畫案件</h2>
                                        <button type="button" onClick={()=>setIsModalOpen(false)} className="p-3 bg-slate-50 rounded-full font-black font-bold"><Icon name="X" size={24}/></button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10 font-black">
                                        <div className="space-y-6 font-black font-bold">
                                            <div className="space-y-1 font-black font-bold font-black"><label className="text-[10px] text-slate-400 uppercase tracking-widest pl-1 font-bold font-black font-bold">專案標題名稱</label><input required className="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold text-slate-700 shadow-inner" placeholder="例如：某某教學設備採購案..." value={newProject.title} onChange={e=>setNewProject({...newProject, title:e.target.value})} /></div>
                                            <div className="grid grid-cols-2 gap-4 font-bold font-black">
                                                <div className="space-y-1 font-black font-bold font-black font-bold"><label className="text-[10px] text-slate-400 uppercase tracking-widest pl-1 font-bold font-black font-bold">預算金額</label><input type="number" className="w-full bg-slate-50 p-5 rounded-2xl outline-none font-bold shadow-inner font-black" placeholder="0" value={newProject.budget} onChange={e=>setNewProject({...newProject, budget:e.target.value})} /></div>
                                                <div className="space-y-1 font-black font-bold font-black font-bold"><label className="text-[10px] text-slate-400 uppercase tracking-widest pl-1 font-bold font-black font-bold font-black">計畫年度</label><select className="w-full bg-slate-100 p-5 rounded-2xl font-bold font-black font-black" value={newProject.year} onChange={e=>setNewProject({...newProject, year:e.target.value})}>{AVAILABLE_YEARS.map(y=><option key={y} value={y}>{y} 年度</option>)}</select></div>
                                            </div>
                                            
                                            <div className="space-y-2 font-black font-bold">
                                                <label className="text-[10px] text-slate-400 uppercase tracking-widest pl-1 font-bold font-black">需求單位 (複選)</label>
                                                <div className="flex flex-wrap gap-2 p-4 bg-slate-50 rounded-2xl border border-slate-100 shadow-inner max-h-32 overflow-y-auto custom-scrollbar font-black">
                                                    {departments.map(d => (
                                                        <button key={d} type="button" onClick={() => handleDeptToggle('new', d)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${newProject.dept.includes(d) ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200'}`}>{d}</button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="space-y-1 font-black font-bold"><label className="text-[10px] text-slate-400 uppercase tracking-widest pl-1 font-bold font-black font-bold">負責人員</label><select required className="w-full bg-slate-100 p-5 rounded-2xl font-bold font-black" value={newProject.handler} onChange={e=>setNewProject({...newProject, handler:e.target.value})}><option value="">請選擇人員</option>{handlers.map(h=><option key={h} value={h}>{h}</option>)}</select></div>
                                            
                                            <div className="bg-indigo-50 p-6 rounded-[2.5rem] border border-indigo-100 flex justify-between items-center font-black">
                                                <div className="flex items-center gap-3 font-bold font-black font-bold"><Icon name="ListTree" color={THEME.indigo} size={20}/><span className="text-sm font-black text-indigo-900 font-bold">啟用分項任務管理</span></div>
                                                <button type="button" onClick={()=>setNewProject({...newProject, hasSubTasks: !newProject.hasSubTasks})} className={`px-6 py-2.5 rounded-xl text-xs font-black transition-all shadow-md ${newProject.hasSubTasks ? 'bg-indigo-600 text-white' : 'bg-white text-slate-400 border border-slate-200'}`}>{newProject.hasSubTasks ? '已開啟' : '點擊開啟'}</button>
                                            </div>
                                        </div>
                                        <div className="bg-slate-50 p-10 rounded-[3rem] space-y-6 shadow-inner border border-slate-100 font-black font-bold font-black font-bold">
                                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2 font-black font-bold"><Icon name="CalendarDays" size={16} color={THEME.purple}/> 計畫期程規劃</h3>
                                            {['demand', 'proc', 'cont'].map(key => (
                                                <div key={key} className="space-y-2 font-black font-bold">
                                                    <p className="text-[10px] text-slate-500 uppercase font-black font-bold font-black font-bold font-black font-bold">{key==='demand'?'1. 需求階段':key==='proc'?'2. 採購階段':'3. 合約階段'}</p>
                                                    <div className="flex gap-2 font-bold font-black font-bold"><input type="date" required className="flex-1 p-4 text-xs rounded-xl border-none shadow-sm font-black" value={newProject[`p_${key}S`]} onChange={e=>{const n={...newProject}; n[`p_${key}S`]=e.target.value; setNewProject(n);}}/><input type="date" required className="flex-1 p-4 text-xs rounded-xl border-none shadow-sm font-black" value={newProject[`p_${key}E`]} onChange={e=>{const n={...newProject}; n[`p_${key}E`]=e.target.value; setNewProject(n);}}/></div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-4 mt-12 font-black font-bold font-black font-bold">
                                        <button type="button" onClick={()=>setIsModalOpen(false)} className="flex-1 py-5 bg-slate-100 text-slate-400 rounded-[2rem] font-black uppercase font-bold font-black font-bold font-black font-bold">取消返回</button>
                                        <button type="submit" className="flex-[2] py-5 text-white font-black rounded-[2rem] shadow-2xl hover:brightness-110 active:scale-95 transition-all font-black" style={{background: THEME.purple}}>正式發布專案</button>
                                    </div>
                                </form>
                            </div>
                        )}

                        {/* 詳細編輯視窗 - 整合所有邏輯 */}
                        {editingProject && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-xl flex items-center justify-center p-4 z-[100] no-print font-black">
                                <div className="bg-white rounded-[3.5rem] w-full max-w-6xl p-10 shadow-2xl animate-fade-in flex flex-col max-h-[90vh] font-black font-bold">
                                    <div className="flex justify-between items-center mb-8 border-b pb-6 font-black font-bold">
                                        <div className="flex items-center gap-4">
                                            <div className="p-3 rounded-2xl bg-slate-900 text-white shadow-lg font-black font-bold font-black font-bold"><Icon name="Edit3" size={24}/></div>
                                            <h2 className="text-2xl font-black text-slate-800">{editingProject.title}</h2>
                                        </div>
                                        <button onClick={()=>setEditingProject(null)} className="p-2 bg-slate-50 rounded-full font-black"><Icon name="X" size={20}/></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto pr-4 custom-scrollbar grid grid-cols-1 lg:grid-cols-2 gap-12 font-black font-bold">
                                        <div className="space-y-8 font-black font-bold font-black font-bold">
                                            <div className="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm font-black font-bold font-black font-bold">
                                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 font-black font-bold">主流程階段手動切換</h3>
                                                <div className="grid grid-cols-5 gap-2 font-bold font-black">
                                                    {STAGE_CONFIG.map(s => (
                                                        <button key={s.id} onClick={()=>setEditingProject(prev => ({...prev, stage: s.id}))} className={`flex flex-col items-center p-3 rounded-xl border transition-all ${editingProject.stage === s.id ? 'bg-indigo-600 text-white shadow-lg font-black font-bold' : 'bg-slate-50 text-slate-400 border-transparent hover:bg-slate-100 font-black'}`}><span className="text-[9px] font-black mb-1 font-bold">STEP {s.id}</span><span className="text-[10px] text-center leading-tight font-black font-bold">{s.name}</span></button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="space-y-4 font-black font-bold">
                                                <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest pl-1 font-bold">主辦單位維護 (複選)</h3>
                                                <div className="flex flex-wrap gap-2 p-4 bg-slate-50 rounded-2xl border border-slate-100 shadow-inner">
                                                    {departments.map(d => (
                                                        <button key={d} type="button" onClick={() => handleDeptToggle('edit', d)} className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${editingProject.dept.includes(d) ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200'}`}>{d}</button>
                                                    ))}
                                                </div>
                                            </div>

                                            <div className="bg-indigo-50/50 p-6 rounded-3xl border border-indigo-100 flex justify-between items-center font-black">
                                                <div className="flex items-center gap-3 font-black"><Icon name="ListTree" color={THEME.indigo}/><span className="font-black text-indigo-900 font-bold">分項工程管理</span></div>
                                                <button type="button" onClick={()=>setEditingProject(prev => ({...prev, hasSubTasks: !prev.hasSubTasks}))} className={`px-5 py-2 rounded-xl text-xs font-black transition-all ${editingProject.hasSubTasks ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-200 text-slate-50'}`}>{editingProject.hasSubTasks ? '關閉功能' : '開啟功能'}</button>
                                            </div>
                                            {editingProject.hasSubTasks && (
                                                <div className="space-y-6 font-black font-bold font-black font-bold">
                                                    <div className="flex gap-2 font-black font-bold">
                                                        <input id="sub-task-input-edit" className="flex-1 bg-slate-50 border-none rounded-2xl px-5 py-3.5 text-sm font-bold shadow-inner font-black" placeholder="輸入分項名稱..." onKeyDown={e=>{if(e.key==='Enter'){addSubTask(e.target.value); e.target.value='';}}} />
                                                        <button type="button" onClick={()=>{const el=document.getElementById('sub-task-input-edit'); addSubTask(el.value); el.value='';}} className="bg-slate-900 text-white px-6 rounded-2xl shadow-lg font-black font-bold">新增</button>
                                                    </div>
                                                    <div className="space-y-4">
                                                        {editingProject.tasks && editingProject.tasks.map(t => (
                                                            <div key={t.id} className="border border-slate-100 rounded-[2rem] p-6 bg-white shadow-sm hover:shadow-md transition-all font-black">
                                                                <div className="flex justify-between items-center mb-4 font-black font-bold"><span className="font-black text-slate-700 font-bold">{t.name}</span><button onClick={()=>setEditingProject(prev => ({...prev, tasks: prev.tasks.filter(x=>x.id!==t.id)}))} className="text-rose-300 font-bold font-black"><Icon name="X" size={16}/></button></div>
                                                                <div className="grid grid-cols-1 gap-3 font-bold font-black">
                                                                    {['demand', 'procurement', 'contract'].map((c, idx) => (
                                                                        <div key={c} className="flex items-center justify-between text-[10px] font-black font-bold">
                                                                            <span className="text-slate-400 uppercase font-bold">{STAGE_CONFIG[idx===3?2:idx===4?3:idx].name}</span>
                                                                            <div className="flex gap-2 font-black font-bold"><input type="date" className="p-2 bg-slate-50 rounded-lg border-none" value={t.actual[c].start} onChange={e=>{
                                                                                const newTasks = editingProject.tasks.map(task => task.id === t.id ? {...task, actual: {...task.actual, [c]: {...task.actual[c], start: e.target.value}}} : task);
                                                                                setEditingProject(prev => ({...prev, tasks: newTasks}));
                                                                            }} /><input type="date" className="p-2 bg-slate-50 rounded-lg border-none" value={t.actual[c].end} onChange={e=>{
                                                                                const newTasks = editingProject.tasks.map(task => task.id === t.id ? {...task, actual: {...task.actual, [c]: {...task.actual[c], end: e.target.value}}} : task);
                                                                                setEditingProject(prev => ({...prev, tasks: newTasks}));
                                                                            }} /></div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="space-y-8 font-black font-bold font-black font-bold">
                                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-[0.2em] border-l-4 border-indigo-500 pl-3 font-black">主計畫期程實際填報</h3>
                                            {['demand', 'procurement', 'contract'].map((cat, idx) => (
                                                <div key={cat} className="space-y-3 font-black font-bold">
                                                    <div className="flex justify-between items-center font-black font-bold"><span className="text-sm font-black text-slate-600 font-black font-bold font-black font-bold">{idx+1}. {STAGE_CONFIG[idx===1?1:idx===2?2:idx].name}</span><span className="text-[10px] text-slate-300 font-black">計畫：{editingProject.planned[cat].start}~{editingProject.planned[cat].end}</span></div>
                                                    <div className="grid grid-cols-2 gap-4 font-bold font-black">
                                                        <div className="bg-slate-50 border border-slate-100 rounded-2xl p-3 font-black font-bold"><label className="block text-[8px] text-slate-400 font-black font-bold mb-1">實際起始</label><input type="date" className="w-full text-xs font-black bg-transparent border-none p-0 outline-none font-bold font-black" value={editingProject.actual[cat].start} onChange={e=>setEditingProject(prev => ({...prev, actual: {...prev.actual, [cat]: {...prev.actual[cat], start: e.target.value}}}))} /></div>
                                                        <div className="bg-slate-50 border border-slate-100 rounded-2xl p-3 font-black font-bold"><label className="block text-[8px] text-slate-400 font-black font-bold mb-1">實際完成</label><input type="date" className="w-full text-xs font-black bg-transparent border-none p-0 outline-none font-bold font-black" value={editingProject.actual[cat].end} onChange={e=>setEditingProject(prev => ({...prev, actual: {...prev.actual, [cat]: {...prev.actual[cat], end: e.target.value}}}))} /></div>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="pt-8 border-t border-slate-50 font-black">
                                                <label className="text-xs font-black text-slate-400 block mb-4 font-black">案件目前狀態</label>
                                                <div className="flex gap-3 mb-6 font-black font-bold">
                                                    {STATUS_CONFIG.map(s => (
                                                        <button key={s.id} onClick={()=>setEditingProject(prev => ({...prev, status: s.id}))} className={`flex-1 py-3 rounded-2xl text-xs font-black border transition-all ${editingProject.status === s.id ? 'bg-slate-900 text-white border-transparent shadow-lg font-bold' : 'bg-white text-slate-400 border-slate-100'}`}>{s.name}</button>
                                                    ))}
                                                </div>
                                                <textarea className="w-full bg-slate-50 border-none rounded-[2rem] p-6 text-sm font-bold shadow-inner outline-none focus:ring-2 focus:ring-purple-100 font-black font-bold" rows="4" placeholder="備註說明..." value={editingProject.remarks || ''} onChange={e=>setEditingProject(prev => ({...prev, remarks: e.target.value}))}></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-4 mt-10 pt-6 border-t border-slate-50 no-print font-black font-bold">
                                        <button onClick={()=>setEditingProject(null)} className="flex-1 py-4 bg-slate-100 text-slate-400 rounded-[2rem] font-black uppercase font-bold">取消返回</button>
                                        <button onClick={()=>updateProjectMain(editingProject)} className="flex-1 py-4 text-white font-black rounded-[2rem] shadow-xl active:scale-95 transition-all font-bold font-black" style={{background: THEME.purple}}>確認更新資料</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 刪除確認 */}
                        {deleteConfirmId && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4 z-[300] no-print font-black font-bold">
                                <div className="bg-white p-12 rounded-[3.5rem] shadow-2xl text-center max-w-sm animate-fade-in font-black">
                                    <div className="w-20 h-20 bg-rose-50 text-rose-600 rounded-3xl flex items-center justify-center mx-auto mb-8 animate-bounce font-black font-bold"><Icon name="AlertTriangle" size={40}/></div>
                                    <h3 className="text-2xl font-black mb-4 font-black font-bold">確定永久移除？</h3>
                                    <p className="text-sm text-slate-400 font-bold mb-10 font-black font-bold">此操作將無法復原，計畫所有資料會清空。</p>
                                    <div className="flex flex-col gap-3 font-black font-bold">
                                        <button onClick={()=>{setProjects(prev => prev.filter(p=>p.id!==deleteConfirmId)); setDeleteConfirmId(null);}} className="py-4 bg-rose-600 text-white rounded-2xl font-black shadow-lg font-black font-bold">確認刪除專案</button>
                                        <button onClick={()=>setDeleteConfirmId(null)} className="py-4 bg-slate-50 text-slate-400 rounded-2xl font-bold font-black font-bold">返回保留</button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
